<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create New Post</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style> body { font-family: 'Plus Jakarta Sans', sans-serif; } </style>
</head>
<body class="min-h-screen bg-gray-100">
<div class="flex items-center justify-center min-h-screen px-6">
  <div class="bg-white shadow-xl rounded-4xl p-10 w-full max-w-4xl">
    <h1 class="text-4xl font-bold text-gray-800 mb-8">Create a New Post</h1>

    <input type="file" id="imageUpload" class="hidden" accept="image/*">
    <label for="imageUpload" class="flex flex-col items-center justify-center border-2 border-dashed p-10 cursor-pointer">
      <span class="text-lg font-semibold">Upload Featured Image</span>
      <span class="text-sm text-gray-500 mb-3">JPG, PNG, GIF</span>
      <span class="bg-blue-100 text-blue-600 px-5 py-2 rounded-lg font-semibold">Choose Image</span>
    </label>

    <img id="previewImage" class="hidden w-full max-h-60 object-cover rounded-lg mt-4 shadow-md">

    <input id="postTitle" type="text" placeholder="Title" class="mt-6 w-full p-3 rounded-lg bg-gray-100 border">
    <textarea id="postContent" rows="8" placeholder="Content" class="mt-4 w-full p-3 rounded-lg bg-gray-100 border"></textarea>

    <select id="postCategory" class="mt-4 w-full p-3 rounded-lg bg-gray-100 border">
      <option value="">Select Category</option>
      <option value="1">Technology</option>
      <option value="2">Travel</option>
      <option value="3">Sports</option>
      <option value="4">Food</option>
      <option value="5">Cinema</option>
      <option value="6">Politics</option>
      <option value="7">Celebrity</option>
      <option value="8">Nature</option>
    </select>

    <div class="flex justify-between gap-6 mt-8">
      <button id="cancelBtn" class="w-full py-3 rounded-lg font-semibold border">Cancel</button>
      <button id="publishBtn" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg">
        Publish Post
      </button>
    </div>
  </div>
</div>

<script>
const fileInput = document.getElementById("imageUpload");
const previewImage = document.getElementById("previewImage");
const publishBtn = document.getElementById("publishBtn");

fileInput.addEventListener("change", () => {
  const file = fileInput.files[0];
  if (!file) return;
  previewImage.src = URL.createObjectURL(file);
  previewImage.classList.remove("hidden");
});

publishBtn.addEventListener("click", uploadPost);

async function uploadPost() {
  publishBtn.disabled = true;
  publishBtn.innerText = "Publishing...";

  const file = fileInput.files[0];
  const title = document.getElementById("postTitle").value.trim();
  const content = document.getElementById("postContent").value.trim();
  const categoryId = Number(document.getElementById("postCategory").value);
  const username = localStorage.getItem("username");

  if (!file || !title || !content || !categoryId || !username) {
    alert("Missing fields or not logged in");
    resetBtn();
    return;
  }

  try {
    // 1Ô∏è‚É£ Upload image
    const formData = new FormData();
    formData.append("file", file);

    const uploadRes = await fetch("/api/upload/image", {
      method: "POST",
      body: formData
    });

    if (!uploadRes.ok) throw new Error("Image upload failed");

    const imageUrl = await uploadRes.text();

    // 2Ô∏è‚É£ Save post (üî• CORRECT FIELD NAMES üî•)
    const postBody = {
      title: title,
      content: content,
      imageUrl: imageUrl,        // ‚úÖ FIXED
      username: username,
      author: username,
      categoryId: categoryId,    // ‚úÖ FIXED
      categoryName: document.querySelector("#postCategory option:checked").text
    };

    const postRes = await fetch("/api/posts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(postBody)
    });

    if (!postRes.ok) throw new Error(await postRes.text());

    alert("Post published successfully!");
    window.location.href = "home.html";

  } catch (err) {
    console.error(err);
    alert("Saving post failed");
    resetBtn();
  }
}

function resetBtn() {
  publishBtn.disabled = false;
  publishBtn.innerText = "Publish Post";
}
</script>



</body>
</html>
